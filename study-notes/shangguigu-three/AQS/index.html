<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.14" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.52" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://mister-hope.github.io/vuepress-theme-home/study-notes/shangguigu-three/AQS/"><meta property="og:site_name" content="æ’„å®çš„åšå®¢"><meta property="og:title" content="AQS"><meta property="og:description" content="AbstractQueuedSynchronizer AQS å‰ç½®çŸ¥è¯† å…¬å¹³é”å’Œéå…¬å¹³é” ï¼š ReentrantLockæœ‰å…¬å¹³é”å’Œéå…¬å¹³é” å¯é‡å…¥é”. LockSupport è‡ªæ—‹é” æ•°æ®ç»“æ„ä¹‹é“¾è¡¨ è®¾è®¡æ¨¡å¼ä¹‹æ¨¡æ¿è®¾è®¡æ¨¡å¼ 1ã€æ˜¯ä»€ä¹ˆ æŠ½è±¡çš„é˜Ÿåˆ—åŒæ­¥å™¨ï¼ˆAbstractQueuedSynchronizer ç®€ç§°ä¸ºAQSï¼‰ æŠ€æœ¯è§£é‡Šï¼š æ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-08-11T14:10:10.000Z"><meta property="article:author" content="æ¨±å®"><meta property="article:tag" content="AQS"><meta property="article:published_time" content="2023-03-18T00:00:00.000Z"><meta property="article:modified_time" content="2024-08-11T14:10:10.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"AQS","image":[""],"datePublished":"2023-03-18T00:00:00.000Z","dateModified":"2024-08-11T14:10:10.000Z","author":[{"@type":"Person","name":"æ¨±å®","url":"https://mister-hope.com"}]}</script><title>AQS | æ’„å®çš„åšå®¢</title><meta name="description" content="AbstractQueuedSynchronizer AQS å‰ç½®çŸ¥è¯† å…¬å¹³é”å’Œéå…¬å¹³é” ï¼š ReentrantLockæœ‰å…¬å¹³é”å’Œéå…¬å¹³é” å¯é‡å…¥é”. LockSupport è‡ªæ—‹é” æ•°æ®ç»“æ„ä¹‹é“¾è¡¨ è®¾è®¡æ¨¡å¼ä¹‹æ¨¡æ¿è®¾è®¡æ¨¡å¼ 1ã€æ˜¯ä»€ä¹ˆ æŠ½è±¡çš„é˜Ÿåˆ—åŒæ­¥å™¨ï¼ˆAbstractQueuedSynchronizer ç®€ç§°ä¸ºAQSï¼‰ æŠ€æœ¯è§£é‡Šï¼š æ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶...">
    <link rel="stylesheet" href="/vuepress-theme-home/assets/css/styles.cfe30387.css">
    <link rel="preload" href="/vuepress-theme-home/assets/js/runtime~app.b73d6d97.js" as="script"><link rel="preload" href="/vuepress-theme-home/assets/css/styles.cfe30387.css" as="style"><link rel="preload" href="/vuepress-theme-home/assets/js/7172.91fc6da6.js" as="script"><link rel="preload" href="/vuepress-theme-home/assets/js/app.c06173f8.js" as="script">
    <link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_RocketMQ_index.html.e9f9da20.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_concurrent-programming_more.html.cbc832b0.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_JVM_index.html.238eb1c6.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-three_AQS_index.html.a0bcec5e.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_concurrent-programming_index.html.32d8ccf8.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_collection_more.html.2abe078d.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-baodian_framework_index.html.bb49d5d0.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-baodian_base_index.html.25972a48.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Bytecode-ClassLoading_Class-File-Structure_index.html.a3609ff2.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_enterprise-scenarios_design-patterns.html.a3a96ba2.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-three_Spring_index.html.a45e6373.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-three_Redis_index.html.f76a2fe0.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_spring-boot_index.html.ae8ecea8.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Bytecode-ClassLoading_Bytecode-Instruction-Set_index.html.5e0aff48.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Bytecode-ClassLoading_Class-Lifecycle2_index.html.976b76fb.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_Heap_index.html.ba0de14d.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Performance-Monitoring-Tuning_JVM-Runtime-Parameters_index.html.58923815.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_StringTable_index.html.142b9c99.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_collection_index.html.deb82f78.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Performance-Monitoring-Tuning_Heap-Memory-Leak_index.html.133b9426.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Bytecode-ClassLoading_Class-Lifecycle_index.html.d066ecdb.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_GC-Relevant-Overview_index.html.1202d7d0.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_ThreadPool_index.html.6c92c37c.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_GC-Period_index.html.2871597f.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/problem-record_merge-pdf.html.6e34ab12.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_Clas-Loading-Subsystem_index.html.8abf77af.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/problem-record_miscellaneous-notes.html.86154f76.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_GC-Relevant-Algorithms_index.html.d3832bd3.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_JVM-Stack_index.html.6039e707.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_index.html.3031eeee.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_BlockingQueue_index.html.d8192d96.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/problem-record_delete-more-iif.html.21978f3c.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/photo-swipe.8b913169.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Performance-Monitoring-Tuning_JVM-Monitoring-Diagnostic-Tools-GUI_index.html.fb361092.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Performance-Monitoring-Tuning_JVM-Monitoring-Diagnostic-Tools_index.html.02b7dafb.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_Method-Area_index.html.5d05d7b0.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_JVM_six.html.8a822808.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_volatile_two.html.5a8dfc1a.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_Java-Architecture_index.html.6c4cf302.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_JVM_four.html.58325c0f.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_ABA_index.html.98e92627.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_Redis_more.html.aac4730f.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/problem-record_HTTPInputStreamExample.html.ab7d6fd8.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-three_UUID_index.html.05d0abf7.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_lock_one.html.05af6e3c.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-baodian_jvm_index.html.c80f4fe1.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_Redis_index.html.90d49c54.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_Execution-Engine_index.html.564ac14d.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_JVM_three.html.e7d646cf.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_JVM_five.html.8d7b0365.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/note-record_index.html.5c7818e0.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_lock_three.html.c6a62b98.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_MySQL_index.html.6f3b577f.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_Linux_index.html.dd341b46.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/web3_index.html.29579638.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/problem-record_idea-template.html.0a6ca1fb.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_ArrayList_index.html.358e67cc.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_frame_spring_index.html.d6ad6b80.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_MySQL_more.html.c9cd3cce.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_volatile_four.html.3013821e.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-three_await-signal.html.a3e319ba.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Performance-Monitoring-Tuning_OQL_index.html.4091239e.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-baodian_concurrency_index.html.23d74049.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-three_two.html.71eecb5c.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_Synchronized-Lock_index.html.0aeee8e3.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_enterprise-scenarios_technical-scenarios.html.9ae13c1f.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-three_WaitNotify_index.html.6f920617.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/demo_markdown.html.b398d30b.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_volatile_one.html.83df47c0.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_Microservices_index.html.d1e3be8c.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_SiSuo_index.html.07d248c9.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/problem-record_github-tips.html.8fbe643a.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Performance-Monitoring-Tuning_GC-Log_index.html.70ab2929.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_CAS_index.html.b2a83034.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-three_ReentrantLock_index.html.36940591.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_frame_mybatis_index.html.b6828063.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_frame_index.html.2ac0eb25.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_GC-Overview_index.html.c562198a.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_PCounter-Register_index.html.abc48310.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_message-middleware_more.html.57ae2863.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/problem-record_redission.html.f1a34282.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_Internet_five_index.html.d0bc3c47.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_Native-Stack_index.html.213687fc.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_Object-Instantiation_index.html.4699dcc1.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_volatile_three.html.2caba5a4.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-three_one.html.d2dbdee8.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_lock_four.html.eaa76b4d.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_Internet_one_index.html.2c70a23c.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_Internet_four_index.html.06e27c35.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_CountDownLatch_CyclicBarrier_Semaphore_Semaphore.html.2a0adaa7.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_CountDownLatch_CyclicBarrier_Semaphore_countDownLatch.html.55464569.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_CountDownLatch_CyclicBarrier_Semaphore_CyclicBarrier.html.a6271076.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/problem-record_interview-transcripts.html.b7783109.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_Internet_https-http_index.html.53f2a402.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_Internet_TCP_index.html.a5a41d5c.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_JVM_two.html.c974897e.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Performance-Monitoring-Tuning_JVM-Overview_index.html.840d446c.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_Internet_http-state_index.html.00b0dd52.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/about-the-blogs_about-learn.html.723323b0.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-three_LockSupport_index.html.ccde69f1.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_Direct-Memory_index.html.eda9a5b6.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_JVM-RuntimeDataAreas_index.html.6d9e6aff.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_lock_six.html.a8ccd0c6.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Memory-GC_index.html.41f08985.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_lock_two.html.2b6e979b.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/interview-related_index.html.d1ee0319.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_github_index.html.e98415ee.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_lock_five.html.1a232f77.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/demo_page.html.fa0b761a.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_JVM_one.html.78d629e3.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Performance-Monitoring-Tuning_index.html.a855eb45.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/vue_basics.html.5ccf84fa.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-three_index.html.b2cfda9b.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/demo_layout.html.6b4591ef.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_JVM_Bytecode-ClassLoading_index.html.108e772e.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_index.html.cc7d666e.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/index.html.611de3bf.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/about-the-blogs_about-blogs.html.45ea3bde.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_Internet_index.html.08a0b86f.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-baodian_index.html.261241fe.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/problem-record_tool.html.e83455f7.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_SpringCloud_index.html.d3c1b718.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/posts_tomato.html.e4616ec3.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/posts_cherry.html.555fb361.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/posts_dragonfruit.html.63ba76d7.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/interview-related_collection.html.c36b04c7.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/interview-related_java-thread.html.d0dfbd62.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/interview-related_network.html.feefef9b.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/posts_strawberry.html.ce5d5c71.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/interview-related_javase.html.be986035.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/interview-related_rocketMQ.html.2f1ff3de.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/demo_disable.html.5d45becf.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/interview-related_mybatis.html.130f845f.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/interview-related_spring.html.0a771312.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/problem-record_idea-tool.html.54ba6b5e.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/interview-related_mysql.html.4ffbea88.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/interview-related_redis.html.35f02fc1.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/interview-related_jvm.html.7755a29f.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/intro.html.60ccafca.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_message-middleware_index.html.b6157615.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/vue_advanced.html.18679c25.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/demo_index.html.4f2f761b.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_Redis_index.html.32850a8f.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_index.html.b25d23b9.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/about-the-blogs_index.html.0f04b052.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/demo_encrypt.html.2f3f55d3.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_CountDownLatch_CyclicBarrier_Semaphore_index.html.903f5c4e.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_å¾…å®Œæˆå­¦ä¹ _index.html.063890ff.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_è®¡ç®—æœºç½‘ç»œ_index.html.ef975700.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_linuxè¯Šæ–­åŸå› _index.html.b22e7971.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_åƒåœ¾æ”¶é›†å™¨_index.html.70179a75.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_è®¡ç®—æœºç½‘ç»œ_index.html.d6d9366c.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_javaä¸­çš„å¼•ç”¨_index.html.c757ddaa.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_pdfæ–‡ä»¶åˆå¹¶_index.html.6c3527e7.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_ä»£ç å®è·µ_index.html.d40d69d4.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_ä½¿ç”¨æŒ‡å—_index.html.da84ba43.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_å¼€å‘å·¥å…·_index.html.7166bbb1.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_æ–‡ä»¶ä¸‹è½½_index.html.63dd5ec7.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_é¢è¯•æŒ‡å—_index.html.e5c052ff.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_åˆ†å¸ƒå¼é”_index.html.c5312d70.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_å­¦ä¹ ç¬”è®°_index.html.7dab73ca.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_ä½¿ç”¨æŒ‡å—_index.html.04418e7c.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_é¡µé¢é…ç½®_index.html.eb248dc1.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_ä¸­é—´ä»¶_index.html.7b289231.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_ç«é¾™æœ_index.html.b9743ae1.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_çº¿ç¨‹æ± _index.html.749b9329.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_çº¿ç¨‹æ± _index.html.0e64c2b0.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_vueç³»åˆ—_index.html.6562acbc.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_countdownlatch_index.html.723ae494.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_blockingqueue_index.html.f4c9707d.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_cyclicbarrier_index.html.e5321195.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_heima-java-bagu_enterprise-scenarios_index.html.04775936.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_abaé—®é¢˜_index.html.744dffb7.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_synchronized_index.html.2c9abdf0.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_ä½œè€…_index.html.ab5b8b1e.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_åšå®¢_index.html.21c81626.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_æŒ‡å—_index.html.4d60365b.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_æ°´æœ_index.html.6e20f370.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_è‰è“_index.html.453e33bf.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_è”¬èœ_index.html.86560017.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_é¢è¯•_index.html.97984cfb.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_é»‘é©¬_index.html.b09900d4.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_springcloud_index.html.b4bbfb2a.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_æ¨±æ¡ƒ_index.html.64b36447.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_springboot_index.html.8bffe702.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_redisson_index.html.b3c2c320.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_åŠ å¯†_index.html.4195ba94.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_æ­»é”_index.html.84ad57fc.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_ç¦ç”¨_index.html.4e0a6935.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_å¸ƒå±€_index.html.23349401.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_semaphore_index.html.0451f3ef.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_markdown_index.html.db02ba92.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_redisson_index.html.6bf48343.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_rocketmq_index.html.244dc33c.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_volatile_index.html.0863f97d.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_python_index.html.1a2517c6.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_github_index.html.d51da241.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_redis_index.html.375cb944.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_github_index.html.37fc630c.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_spring_index.html.42e864db.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_index.html.40178b3b.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_code_index.html.ad19a45a.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_web3_index.html.2b719bd7.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_idea_index.html.a56177bb.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_redis_index.html.09a3b6fb.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_åœ†_index.html.94778b1b.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_å¤§_index.html.b05936b6.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_å°_index.html.f50462be.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_çº¢_index.html.6ffd9e0e.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_é”_index.html.afc168e8.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_juc_index.html.247c1dc4.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_lock_index.html.7fb63f6d.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_web3_index.html.013790ef.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_volatile_index.html.16ed8ae1.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_aqs_index.html.ad749dee.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_cas_index.html.d6664bf0.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_git_index.html.59a72e4b.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_jvm_index.html.72b351e7.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_oom_index.html.f55d54cc.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_juc_index.html.11565209.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/404.html.c3bdcdc1.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/timeline_index.html.093757be.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/problem-record_index.html.45b6e054.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_lock_index.html.b10e07a6.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/category_index.html.a676323d.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/study-notes_shangguigu-second_JVM_index.html.72517d3e.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/article_index.html.a5ee5066.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/tag_index.html.22713e66.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/star_index.html.234d9fb4.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/posts_index.html.f9be0e00.js" as="script"><link rel="prefetch" href="/vuepress-theme-home/assets/js/vue_index.html.dd00237e.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/vuepress-theme-home/"><img class="vp-nav-logo" src="https://theme-hope-assets.vuejs.press/logo.svg" alt><!----><span class="vp-site-name hide-in-pad">æ’„å®çš„åšå®¢</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/vuepress-theme-home/" aria-label="é¦–é¡µ"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span><!--]-->é¦–é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/vuepress-theme-home/study-notes/" aria-label="å­¦ä¹ ç¬”è®°"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-wand-magic-sparkles" style=""></span><!--]-->å­¦ä¹ ç¬”è®°<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/vuepress-theme-home/interview-related/" aria-label="é¢è¯•æŒ‡å—"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-pen-to-square" style=""></span><!--]-->é¢è¯•æŒ‡å—<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/vuepress-theme-home/problem-record/" aria-label="æ‚è®°"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-eye" style=""></span><!--]-->æ‚è®°<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/vuepress-theme-home/note-record/" aria-label="ç¬”è®°æ€»ç»“"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-eye" style=""></span><!--]-->ç¬”è®°æ€»ç»“<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/vuepress-theme-home/web3/" aria-label="web3ç³»åˆ—"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-fire" style=""></span><!--]-->web3ç³»åˆ—<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/vuepress-theme-home/vue/" aria-label="Vueç³»åˆ—"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-fire" style=""></span><!--]-->Vueç³»åˆ—<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/vuepress-theme-home/about-the-blogs/" aria-label="åšå®¢ç›¸å…³"><!--[--><span class="font-icon icon fa-fw fa-sm fas fa-blog" style=""></span><!--]-->åšå®¢ç›¸å…³<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!----><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">å¤§å‚é¢è¯•ç¬¬äºŒå­£</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">å¤§å‚é¢è¯•ç¬¬ä¸‰å­£</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress-theme-home/study-notes/shangguigu-three/" aria-label="å¤§å‚é¢è¯•é¢˜ç¬¬ä¸‰å­£"><!---->å¤§å‚é¢è¯•é¢˜ç¬¬ä¸‰å­£<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress-theme-home/study-notes/shangguigu-three/one.html" aria-label="å­—ç¬¦ä¸²å¸¸é‡Javaå†…éƒ¨åŠ è½½"><!---->å­—ç¬¦ä¸²å¸¸é‡Javaå†…éƒ¨åŠ è½½<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress-theme-home/study-notes/shangguigu-three/two.html" aria-label="é—²èŠåŠ›æ‰£ç®—æ³•ç¬¬ä¸€é¢˜"><!---->é—²èŠåŠ›æ‰£ç®—æ³•ç¬¬ä¸€é¢˜<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress-theme-home/study-notes/shangguigu-three/ReentrantLock/" aria-label="å¯é‡å…¥é”ç†è®º"><!---->å¯é‡å…¥é”ç†è®º<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress-theme-home/study-notes/shangguigu-three/LockSupport/" aria-label="LockSupport"><!---->LockSupport<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress-theme-home/study-notes/shangguigu-three/WaitNotify/" aria-label="çº¿ç¨‹ç­‰å¾…å”¤é†’æœºåˆ¶"><!---->çº¿ç¨‹ç­‰å¾…å”¤é†’æœºåˆ¶<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress-theme-home/study-notes/shangguigu-three/await-signal.html" aria-label="await - signalé™åˆ¶"><!---->await - signalé™åˆ¶<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/vuepress-theme-home/study-notes/shangguigu-three/AQS/" aria-label="AQS"><!---->AQS<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress-theme-home/study-notes/shangguigu-three/Spring/" aria-label="Spring"><!---->Spring<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress-theme-home/study-notes/shangguigu-three/Redis/" aria-label="Redis"><!---->Redis<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress-theme-home/study-notes/shangguigu-three/UUID/" aria-label="é›†ç¾¤é«˜å¹¶å‘æƒ…å†µä¸‹å¦‚ä½•ä¿è¯åˆ†å¸ƒå¼å”¯ä¸€å…¨å±€Idç”Ÿæˆ"><!---->é›†ç¾¤é«˜å¹¶å‘æƒ…å†µä¸‹å¦‚ä½•ä¿è¯åˆ†å¸ƒå¼å”¯ä¸€å…¨å±€Idç”Ÿæˆ<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">é»‘é©¬Javaå…«è‚¡</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">é»‘é©¬é¢è¯•å®å…¸</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">JVM</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">è®¡ç®—æœºç½‘ç»œ</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">SpringBoot</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">SpringCloud</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">RocketMQ</span><span class="vp-arrow end"></span></button><!----></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/vuepress-theme-home/study-notes/Redis/" aria-label="Redis"><!---->Redis<!----></a></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->AQS</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://mister-hope.com" target="_blank" rel="noopener noreferrer">æ¨±å®</a></span><span property="author" content="æ¨±å®"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-03-18T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 21 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT21M"></span><!----><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color1 clickable" role="navigation">AQS</span><!--]--><meta property="keywords" content="AQS"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#abstractqueuedsynchronizer-aqs">AbstractQueuedSynchronizer    AQS</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_1ã€æ˜¯ä»€ä¹ˆ">1ã€æ˜¯ä»€ä¹ˆ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2ã€aqsä¸ºä»€ä¹ˆæ˜¯jucå†…å®¹ä¸­æœ€é‡è¦çš„åŸºçŸ³">2ã€AQSä¸ºä»€ä¹ˆæ˜¯JUCå†…å®¹ä¸­æœ€é‡è¦çš„åŸºçŸ³</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3ã€èƒ½å¹²å˜›">3ã€èƒ½å¹²å˜›</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4ã€aqsåˆæ­¥">4ã€AQSåˆæ­¥</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5ã€ä»æˆ‘ä»¬çš„reentrantlockå¼€å§‹è§£è¯»aqs-é‡ç‚¹">5ã€ä»æˆ‘ä»¬çš„ReentrantLockå¼€å§‹è§£è¯»AQSï¼ˆé‡ç‚¹ï¼‰</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#aqsè€ƒç‚¹">AQSè€ƒç‚¹</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h2 id="abstractqueuedsynchronizer-aqs" tabindex="-1"><a class="header-anchor" href="#abstractqueuedsynchronizer-aqs"><span>AbstractQueuedSynchronizer AQS</span></a></h2><h3 id="å‰ç½®çŸ¥è¯†" tabindex="-1"><a class="header-anchor" href="#å‰ç½®çŸ¥è¯†"><span>å‰ç½®çŸ¥è¯†</span></a></h3><ol><li>å…¬å¹³é”å’Œéå…¬å¹³é” ï¼š ReentrantLockæœ‰å…¬å¹³é”å’Œéå…¬å¹³é”</li><li>å¯é‡å…¥é”.</li><li>LockSupport</li><li>è‡ªæ—‹é”</li><li>æ•°æ®ç»“æ„ä¹‹é“¾è¡¨</li><li>è®¾è®¡æ¨¡å¼ä¹‹æ¨¡æ¿è®¾è®¡æ¨¡å¼</li></ol><h3 id="_1ã€æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#_1ã€æ˜¯ä»€ä¹ˆ"><span>1ã€æ˜¯ä»€ä¹ˆ</span></a></h3><p><code>æŠ½è±¡çš„é˜Ÿåˆ—åŒæ­¥å™¨ï¼ˆAbstractQueuedSynchronizer ç®€ç§°ä¸ºAQSï¼‰</code></p><p>æŠ€æœ¯è§£é‡Šï¼š æ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶å®ƒåŒæ­¥å™¨ç»„ä»¶çš„<strong>é‡é‡çº§åŸºç¡€æ¡†æ¶åŠæ•´ä¸ªJUCä½“ç³»çš„åŸºçŸ³</strong>ï¼Œé€šè¿‡å†…ç½®çš„FIFO<strong>é˜Ÿåˆ—</strong>æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¹¶é€šè¿‡ä¸€ä¸ª<strong>intç±»å‹å˜é‡</strong>è¡¨ç¤ºæŒæœ‰é”çš„çŠ¶æ€ã€‚ æŠ½è±¡çš„é˜Ÿåˆ—åŒæ­¥å™¨ï¼šæ¨¡æ¿æ¨¡å¼ï¼Œæ˜¯JUCå†…å®¹ä¸­æœ€é‡è¦çš„åŸºçŸ³ã€‚</p><ol><li><p>æºä»£ç ï¼š</p><figure><img src="/vuepress-theme-home/assets/img/image-20210919155217016.0db050b9.png" alt="image-20210919155217016" tabindex="0" loading="lazy"><figcaption>image-20210919155217016</figcaption></figure><figure><img src="/vuepress-theme-home/assets/img/image-20210919155413382.263ba961.png" alt="image-20210919155413382" tabindex="0" loading="lazy"><figcaption>image-20210919155413382</figcaption></figure></li></ol><p><strong>è§£é‡Šè¯´æ˜</strong></p><p>æ„å»ºé”ï¼šè¯´é”-&gt;ReentrantLockå°±æ˜¯é”ã€‚å…¶ä»–åŒæ­¥å™¨ç»„ä»¶æŒ‡çš„æ˜¯CountDownLatchã€Semaphoreã€CyclicBarrierç­‰ç­‰ç”šè‡³è¯»å†™é”ï¼Œè¿™ä¸€å¥—JUCçš„èƒ½å¤Ÿè·Ÿé”ç›¸å…³çš„ç»„ä»¶ï¼Œä»–ä»¬éƒ½éœ€è¦æœ‰ä¸€äº›é€šç”¨çš„ç‰¹æ€§ã€‚ä¸å…¶äººäººå¸¦ä¸€ä»½ï¼Œä¸å¦‚åšä¸€ä¸ªæŠ½è±¡ç±»æˆä¸ºæœ€é«˜çº§çš„ä¸Šå¸è§†è§’çš„ä¸€ä¸ªçˆ¶ç±»ï¼Œæ¥è¿›è¡Œè¿™äº›é‡é‡çº§çš„åŸºç¡€æ¡†æ¶å½¢æˆæ•´ä¸ªJUCä½“ç³»çš„åŸºçŸ³ï¼Œæ‰€ä»¥è¯´å†æ¬¡å¼ºè°ƒAQSæ˜¯åŸºçŸ³ç±»çš„æ¡†æ¶ã€‚</p><p>ä»–å†…éƒ¨é€šè¿‡å†…ç½®çš„å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—æ¥å®Œæˆèµ„æºçš„è·å–å’Œçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå¹¶é€šè¿‡ä¸€ä¸ª<strong>intç±»å‹å˜é‡</strong>è¡¨ç¤ºæŒæœ‰é”çš„çŠ¶æ€ã€‚ç±»ä¼¼äºä¸€ä¸ªä¿¡å·ç¯ï¼Œå¦‚æœç°åœ¨æ˜¯0è¿™ä¸ªintå‹çš„è¯´æ˜æ²¡æœ‰äººæŠ¢åˆ°é”ï¼Œå¦‚æœintå‹æ˜¯1è¯´æ˜æŸä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰è¿™ä¸ªé”ï¼Œè¢«æŠ¢åˆ°äº†ï¼Œé‚£ä¹ˆå…¶ä»–æ²¡æœ‰æŠ¢åˆ°é”çš„å°†è¦æŠŠæ”¾åˆ°é˜Ÿåˆ—é‡Œé¢è¿›è¡Œç®¡ç†ï¼Œå¹¶å®‰æ’ä»–ä»¬ç»§ç»­æŠ¢é”ï¼Œè¿™ä¸ªé˜Ÿåˆ—æœ‰ç‚¹åƒåœ¨çº¿ç¨‹æ± é‡Œè®²çš„é“¶è¡Œæ’é˜Ÿçš„å€™å®¢åŒºã€‚ æ€»ç»“ï¼š</p><figure><img src="/vuepress-theme-home/assets/img/image-20210919162552550.201a0cb8.png" alt="image-20210919162552550" tabindex="0" loading="lazy"><figcaption>image-20210919162552550</figcaption></figure><p>ä¸€ä¸ªé˜Ÿåˆ—å°†ä¸€ä¸ªintç±»å‹å˜é‡è¡¨ç¤ºæŒæœ‰é”çš„çŠ¶æ€å®ƒå«stateï¼ˆä¸Šå›¾ä¸­çš„èµ„æºstateï¼‰ï¼Œ</p><h3 id="_2ã€aqsä¸ºä»€ä¹ˆæ˜¯jucå†…å®¹ä¸­æœ€é‡è¦çš„åŸºçŸ³" tabindex="-1"><a class="header-anchor" href="#_2ã€aqsä¸ºä»€ä¹ˆæ˜¯jucå†…å®¹ä¸­æœ€é‡è¦çš„åŸºçŸ³"><span>2ã€AQSä¸ºä»€ä¹ˆæ˜¯JUCå†…å®¹ä¸­<strong>æœ€é‡è¦çš„åŸºçŸ³</strong></span></a></h3><p>ä¸€ã€ å’ŒAQSæœ‰å…³çš„</p><ol><li><code>ReentrantLock</code> ---------------------ç‰µæ‰¯åˆ°å„ç§çŠ¶æ€çš„å˜åŒ–ï¼Œéœ€è¦æŒæœ‰é”æŠ¢å é”ï¼Œæ”¾å¼ƒè·å¾—é”ç­‰ç­‰</li><li>CountDownLatch-------------------ç­é•¿æœ€åå…³é—¨ã€ç§¦ç­å…­å›½ä¸€ç»Ÿåå¤</li><li>ReentrantReadWriteLock--------è¯»å†™é”</li><li>Semaphore--------------------------ä¿¡å·ç¯ã€ä¿¡å·é‡</li><li>ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</li></ol><p>è¿™äº›ç±»è¡¨é¢ä¸Šæ˜¯å››ä¸ªï¼Œä½†æ˜¯ä»–ä»¬éƒ½æœ‰é€šç”¨çš„éœ€è¦å»æŠ¢é”ã€æ”¾é”ç­‰ç­‰ä¸€äº›ç›¸å…³çš„å¿…é¡»è¦æœ‰ä¸€ä¸ªè€å¤§å¸®æˆ‘ä»¬ç»Ÿä¸€æ„å»ºï¼Œä»¥ä¾¿å½¢æˆç»Ÿä¸€ã€è§„èŒƒã€è‰¯å¥½çš„ä½“ç³»ã€‚</p><p>æºç å¦‚ä¸‹ï¼š</p><figure><img src="/vuepress-theme-home/assets/img/image-20210919163821595.b5447397.png" alt="image-20210919163821595" tabindex="0" loading="lazy"><figcaption>image-20210919163821595</figcaption></figure><figure><img src="/vuepress-theme-home/assets/img/image-20210919163932621.14d5d3be.png" alt="image-20210919163932621" tabindex="0" loading="lazy"><figcaption>image-20210919163932621</figcaption></figure><figure><img src="/vuepress-theme-home/assets/img/image-20210919164053236.54ac6e8a.png" alt="image-20210919164053236" tabindex="0" loading="lazy"><figcaption>image-20210919164053236</figcaption></figure><figure><img src="/vuepress-theme-home/assets/img/image-20210919164216517.e4f505bb.png" alt="image-20210919164216517" tabindex="0" loading="lazy"><figcaption>image-20210919164216517</figcaption></figure><figure><img src="/vuepress-theme-home/assets/img/7ecbe7fbeecd5d5e20b2d8de59e8a033.f677f494.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>äºŒã€ è¿›ä¸€æ­¥ç†è§£é”å’ŒåŒæ­¥å™¨çš„å…³ç³»</p><ol><li>é”ï¼Œé¢å‘é”çš„<code>ä½¿ç”¨è€…</code> - å®šä¹‰äº†ç¨‹åºå‘˜å’Œé”äº¤äº’çš„ä½¿ç”¨å±‚APlï¼Œéšè—äº†å®ç°ç»†èŠ‚ï¼Œä½ è°ƒç”¨å³å¯</li><li>åŒæ­¥å™¨ï¼Œé¢å‘é”çš„<code>å®ç°è€…</code> - æ¯”å¦‚Javaå¹¶å‘å¤§ç¥DougLeeï¼Œæå‡ºç»Ÿä¸€è§„èŒƒå¹¶ç®€åŒ–äº†é”çš„å®ç°ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€ç®¡ç†ã€é˜»å¡çº¿ç¨‹æ’é˜Ÿå’Œé€šçŸ¥ã€å”¤é†’æœºåˆ¶ç­‰ã€‚</li></ol><h3 id="_3ã€èƒ½å¹²å˜›" tabindex="-1"><a class="header-anchor" href="#_3ã€èƒ½å¹²å˜›"><span>3ã€èƒ½å¹²å˜›</span></a></h3><p><code>åŠ é”ä¼šå¯¼è‡´é˜»å¡</code>:æœ‰é˜»å¡å°±éœ€è¦æ’é˜Ÿï¼Œå®ç°æ’é˜Ÿå¿…ç„¶éœ€è¦æœ‰æŸç§å½¢å¼çš„é˜Ÿåˆ—æ¥è¿›è¡Œç®¡ç†</p><p><strong>è§£é‡Šè¯´æ˜</strong>ï¼š</p><p>æŠ¢åˆ°èµ„æºçš„çº¿ç¨‹ç›´æ¥ä½¿ç”¨å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼ŒæŠ¢ä¸åˆ°èµ„æºçš„å¿…ç„¶æ¶‰åŠä¸€ç§<code>æ’é˜Ÿç­‰å€™æœºåˆ¶</code>ã€‚ æŠ¢å èµ„æºå¤±è´¥çš„çº¿ç¨‹ç»§ç»­å»ç­‰å¾…(ç±»ä¼¼é“¶è¡Œä¸šåŠ¡åŠç†çª—å£éƒ½æ»¡äº†ï¼Œæš‚æ—¶æ²¡æœ‰å—ç†çª—å£çš„é¡¾å®¢åªèƒ½å»<code>å€™å®¢åŒºæ’é˜Ÿç­‰å€™</code>)ï¼Œä½†ç­‰å€™çº¿ç¨‹ä»ç„¶ä¿ç•™è·å–é”çš„å¯èƒ½ä¸”è·å–é”æµç¨‹ä»åœ¨ç»§ç»­(å€™å®¢åŒºçš„é¡¾å®¢ä¹Ÿåœ¨ç­‰ç€å«å·ï¼Œè½®åˆ°äº†å†å»å—ç†çª—å£åŠç†ä¸šåŠ¡)ã€‚</p><p>æ—¢ç„¶è¯´åˆ°äº†<code>æ’é˜Ÿç­‰å€™æœºåˆ¶</code>ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šæœ‰æŸç§é˜Ÿåˆ—å½¢æˆï¼Œè¿™æ ·çš„é˜Ÿåˆ—æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢?</p><p>å¦‚æœå…±äº«èµ„æºè¢«å ç”¨ï¼Œ<code>å°±éœ€è¦ä¸€å®šçš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ¥ä¿è¯é”åˆ†é…</code>ã€‚è¿™ä¸ªæœºåˆ¶ä¸»è¦ç”¨çš„æ˜¯CLHé˜Ÿåˆ—çš„å˜ä½“å®ç°çš„ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—å°±æ˜¯AQSçš„æŠ½è±¡è¡¨ç°ã€‚å®ƒå°†è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆé˜Ÿåˆ—çš„ç»“ç‚¹(<code>Node</code>)ï¼Œé€šè¿‡CASã€è‡ªæ—‹ä»¥åŠLockSupport.park()çš„æ–¹å¼ï¼Œç»´æŠ¤stateå˜é‡çš„çŠ¶æ€ï¼Œä½¿å¹¶å‘è¾¾åˆ°åŒæ­¥çš„æ§åˆ¶æ•ˆæœã€‚</p><h3 id="_4ã€aqsåˆæ­¥" tabindex="-1"><a class="header-anchor" href="#_4ã€aqsåˆæ­¥"><span>4ã€AQSåˆæ­¥</span></a></h3><ol><li><p>å®˜ç½‘è§£é‡Š</p><figure><img src="/vuepress-theme-home/assets/img/image-20210919235111415.3b3c8bb8.png" alt="image-20210919235111415" tabindex="0" loading="lazy"><figcaption>image-20210919235111415</figcaption></figure></li><li><p>æœ‰é˜»å¡å°±éœ€è¦æ’é˜Ÿï¼Œå®ç°æ’é˜Ÿå¿…ç„¶éœ€è¦é˜Ÿåˆ—</p></li></ol><p>AQSä½¿ç”¨ä¸€ä¸ªvolatileçš„intç±»å‹çš„æˆå‘˜å˜é‡æ¥è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„FIFoé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çš„æ’é˜Ÿå·¥ä½œå°†æ¯æ¡è¦å»æŠ¢å èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ªNodeï¼ŒèŠ‚ç‚¹æ¥å®ç°é”çš„åˆ†é…ï¼Œé€šè¿‡CASå®Œæˆå¯¹Stateå€¼çš„ä¿®æ”¹ã€‚</p><figure><img src="/vuepress-theme-home/assets/img/image-20210919235441792.5f1f6ee2.png" alt="image-20210919235441792" tabindex="0" loading="lazy"><figcaption>image-20210919235441792</figcaption></figure><p>ä¸Šå›¾ä¸­çš„Node{...}å°±æ˜¯ä»¥åå½¢æˆçš„AQSé˜Ÿåˆ—é‡Œé¢æ‰€è£…è½½çš„ä¸€ä¸ªä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªä¸ªNodeè£…åˆ°AQSé‡Œ</p><figure><img src="/vuepress-theme-home/assets/img/image-20210919235906290.10d73494.png" alt="image-20210919235906290" tabindex="0" loading="lazy"><figcaption>image-20210919235906290</figcaption></figure><p>mapé‡Œé¢ä¸æ˜¯æ”¾Kï¼ŒVé”®å€¼å¯¹ï¼Œä¸¥è°¨çš„è¯ï¼Œä»–æ˜¯æ”¾Node&lt;k,v&gt;èŠ‚ç‚¹,èŠ‚ç‚¹é‡Œæ”¾Kï¼ŒVï¼Œç„¶åNodeèŠ‚ç‚¹å†æ”¾åˆ°HashMap</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">   New</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> HashMap</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">put</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="/vuepress-theme-home/assets/img/image-20210920000253132.af1e8f82.png" alt="image-20210920000253132" tabindex="0" loading="lazy"><figcaption>image-20210920000253132</figcaption></figure><figure><img src="/vuepress-theme-home/assets/img/image-20210920000519045.9c8af128.png" alt="image-20210920000519045" tabindex="0" loading="lazy"><figcaption>image-20210920000519045</figcaption></figure><figure><img src="/vuepress-theme-home/assets/img/image-20210920000326070.1f2cdbb6.png" alt="image-20210920000326070" tabindex="0" loading="lazy"><figcaption>image-20210920000326070</figcaption></figure><p>putåº•å±‚è°ƒç”¨putValæ–¹æ³•ï¼ŒåŸºç¡€ç­è®²è¿‡ï¼ŒHashMapæ˜¯ä¸€ä¸ªæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ç»“æ„ï¼Œæ•°ç»„æ˜¯ä¸€ä¸ªä»€ä¹ˆç±»å‹çš„ç»“æ„ï¼Œæ•°ç»„æ˜¯ä¸€ä¸ªä»¥Kï¼ŒVé”®å€¼å¯¹ä½œä¸ºè½½ä½“ã€ä½œä¸ºåª’ä»‹çš„ä¸€ä¸ªNode&lt;k,v&gt;ç±»å‹çš„æ•°ç»„ ã€‚</p><figure><img src="/vuepress-theme-home/assets/img/image-20210920001101761.deb263e8.png" alt="image-20210920001101761" tabindex="0" loading="lazy"><figcaption>image-20210920001101761</figcaption></figure><p>åœ¨HashMapé‡Œä¸¢çš„æ˜¯Kï¼ŒVé”®å€¼å¯¹ï¼Œåœ¨æŠ½è±¡çš„é˜Ÿåˆ—åŒæ­¥å™¨é‡Œä¸¢çš„æ˜¯ä¸€ä¸ªä¸ªçš„Threadçº¿ç¨‹ï¼ŒAbstractQueuedSynchronizer åŒä¸Šå®ƒç®¡çš„æ˜¯ä¸€ä¸ªä¸ªæ²¡æœ‰æŠ¢åˆ°é”çš„çº¿ç¨‹Threadï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯ç›´æ¥æŠŠçº¿ç¨‹ä¹Ÿæ‰”åˆ°æŠ½è±¡çš„é˜Ÿåˆ—åŒæ­¥å™¨é‡Œé¢å‘¢ï¼Ÿæ²¡æœ‰ï¼Œä»–ä¹Ÿå¤šäº†ä¸€é“æ‰‹åºï¼Œè€Œè¿™é“æ‰‹åºä¹Ÿæ˜¯NodeèŠ‚ç‚¹ï¼Œè¿™ä¸ª<code>Node&lt; Thread &gt;</code>è¢«æ‰”è¿›å»çš„æ˜¯ä¸€ä¸ªä¸ªçš„çº¿ç¨‹ï¼Œç›¸å½“äºè¦æŠŠçº¿ç¨‹åšä¸€æ¬¡è½½ä½“çš„å°è£…ï¼Œè®©Nodeä½œä¸ºæ‰¿æ¥çš„è½½ä½“ï¼Œæ”¾åˆ°é˜Ÿåˆ—é‡Œé¢</p><figure><img src="/vuepress-theme-home/assets/img/image-20210920012145873.6fd078cb.png" alt="image-20210920012145873" tabindex="0" loading="lazy"><figcaption>image-20210920012145873</figcaption></figure><p>AQSé˜Ÿåˆ—å°±æ˜¯åœ¨CLH lockåŸºç¡€ä¸Šåšäº†å˜ç§ï¼Œä»å•å‘å˜æˆåŒå‘</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">   static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">       volatile</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> prev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> //å‰æŒ‡é’ˆ</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">   </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">           /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * Link to the successor node that the current node/thread</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * unparks upon release. Assigned during enqueuing, adjusted</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * when bypassing cancelled predecessors, and nulled out (for</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * sake of GC) when dequeued.  The enq operation does not</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * assign next field of a predecessor until after attachment,</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * so seeing a null next field does not necessarily mean that</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * node is at end of queue. However, if a next field appears</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * to be null, we can scan prev&#39;s from the tail to</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * double-check.  The next field of cancelled nodes is set to</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * point to the node itself instead of null, to make life</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * easier for isOnSyncQueue.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">           volatile</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> //åæŒ‡é’ˆ</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">           /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * The thread that enqueued this node.  Initialized on</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            * construction and nulled out after use. ä½¿æ­¤nodeèŠ‚ç‚¹æ’é˜Ÿçš„çº¿ç¨‹ã€‚æ„é€ æ—¶åˆå§‹åŒ–ï¼Œä½¿ç”¨åä¸ºç©ºã€‚</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">           volatile</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Thread</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">           ......</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p><strong>AQSå†…éƒ¨ä½“ç³»æ¶æ„</strong></p><figure><img src="/vuepress-theme-home/assets/img/image-20210920013145555.804c024b.png" alt="image-20210920013145555" tabindex="0" loading="lazy"><figcaption>image-20210920013145555</figcaption></figure><figure><img src="/vuepress-theme-home/assets/img/image-20210920013242117.3f5ee98a.png" alt="image-20210920013242117" tabindex="0" loading="lazy"><figcaption>image-20210920013242117</figcaption></figure><p>AbstractQueuedSynchronizer å†…éƒ¨æœ‰NodeèŠ‚ç‚¹ï¼ˆå†…éƒ¨ç±»ï¼‰ï¼Œsyncï¼ˆè“è‰²æ˜¯ç»§æ‰¿ï¼‰ç»§æ‰¿äºAQSï¼ŒLockæœ‰å®ç°ç±»ReentrantLockï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯syncè¿™ä¸ªç±»ï¼Œsyncè¿™ä¸ªç±»æ˜¯AQSçš„å­ç±»ï¼ŒæŠ¢åˆ°é”çš„ç›´æ¥ä½¿ç”¨ï¼ŒæŠ¢ä¸åˆ°é”çš„è¿›å»æ’é˜Ÿï¼ŒReentrantLockæœ‰å…¬å¹³é”ã€éå…¬å¹³é”ï¼ŒæŠ¢å é”è¿‡ç¨‹æœ‰ä¸¤ç§å½¢å¼ã€‚</p></li><li><p>AQSè‡ªèº«</p></li><li><p><strong>AQSçš„intå˜é‡</strong> --</p></li><li><p>AQSçš„åŒæ­¥çŠ¶æ€stateæˆå‘˜å˜é‡</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">    *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> The</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> synchronization state</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> volatile</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> state</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>é“¶è¡ŒåŠç†ä¸šåŠ¡çš„å—ç†çª—å£çŠ¶æ€</p><p>stateæˆå‘˜å˜é‡ç›¸å½“äºé“¶è¡ŒåŠç†ä¸šåŠ¡çš„å—ç†çª—å£çŠ¶æ€ã€‚</p><ul><li>é›¶å°±æ˜¯æ²¡äººï¼Œè‡ªç”±çŠ¶æ€å¯ä»¥åŠç†</li><li>å¤§äºç­‰äº1ï¼Œæœ‰äººå ç”¨çª—å£ï¼Œç­‰ç€å»</li></ul></li><li><p>AQSçš„CLHé˜Ÿåˆ—</p></li></ol><ul><li>CLHé˜Ÿåˆ—(ä¸‰ä¸ªå¤§ç‰›çš„åå­—ç»„æˆ)ï¼Œä¸ºä¸€ä¸ªåŒå‘é˜Ÿåˆ—</li></ul><figure><img src="/vuepress-theme-home/assets/img/image-20210920014623186.f3fb195c.png" alt="image-20210920014623186" tabindex="0" loading="lazy"><figcaption>image-20210920014623186</figcaption></figure><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">   /**he wait queue is a variant of a &quot;CLH&quot; (Craig, Landin, and</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * Hagersten) lock queue. CLH locks are normally used for</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * spinlocks.  We instead use them for blocking synchronizers, but</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * use the same basic tactic of holding some of the control</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * information about a thread in the predecessor of its node.  A</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * &quot;status&quot; field in each node keeps track of whether a thread</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * should block.  A node is signalled when its predecessor</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * releases.  Each node of the queue otherwise serves as a</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * specific-notification-style monitor holding a single waiting</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * thread. The status field does NOT control whether threads are</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * granted locks etc though.  A thread may try to acquire if it is</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * first in the queue. But being first does not guarantee success;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * it only gives the right to contend.  So the currently released</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * contender thread may need to rewait.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    è¿™ä¸ªç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ç³»åˆ—çš„CLHç»„æˆçš„ã€‚CLHé”é€šå¸¸æ˜¯é€šè¿‡è‡ªæ—‹ç­‰å¾…ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    Stateå˜é‡åˆ¤æ–­æ˜¯å¦é˜»å¡</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    åŠ å…¥CLHé˜Ÿåˆ—ï¼Œä»å°¾éƒ¨å…¥é˜Ÿï¼Œä»å¤´éƒ¨å‡ºé˜Ÿã€‚</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    */</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    AQS </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> state </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> CLHé˜Ÿåˆ—</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é“¶è¡Œå€™å®¢åŒºçš„ç­‰å¾…é¡¾å®¢</li></ul><ol><li><strong>å°æ€»ç»“</strong></li></ol><ul><li>æœ‰é˜»å¡å°±éœ€è¦æ’é˜Ÿï¼Œå®ç°æ’é˜Ÿå¿…ç„¶éœ€è¦é˜Ÿåˆ—</li><li><strong>stateå˜é‡+CLHå˜ç§çš„åŒç«¯é˜Ÿåˆ—</strong></li></ul><ol start="2"><li>å†…éƒ¨ç±»Nodeï¼ˆNodeç±»åœ¨AQSç±»çš„å†…éƒ¨ï¼‰</li></ol><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    AbstractQueuedSynchronizer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">java</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">	</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            //å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ï¼ˆé‡ç‚¹ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">           //è¯´äººè¯ï¼š</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">           //ç­‰å€™åŒºå…¶å®ƒé¡¾å®¢(å…¶å®ƒçº¿ç¨‹)çš„ç­‰å¾…çŠ¶æ€</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">           //é˜Ÿåˆ—ä¸­æ¯ä¸ªæ’é˜Ÿçš„ä¸ªä½“å°±æ˜¯ä¸€ä¸ªNode</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">           //åˆå§‹ä¸º0ï¼ŒçŠ¶æ€ä¸Šé¢çš„å‡ ç§</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">            *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Status</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> field</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> taking on only the values</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">           volatile</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> waitStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">           </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            //å‰é©±èŠ‚ç‚¹ï¼ˆé‡ç‚¹ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">            *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Link</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> to predecessor node that current node</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">/</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">thread relies on</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">           volatile</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> prev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  // å‰æŒ‡é’ˆ</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">   </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">           //åç»§èŠ‚ç‚¹ï¼ˆé‡ç‚¹ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">            *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Link</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> to the successor node that the current node</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">/</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">thread</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">           volatile</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // åæŒ‡é’ˆ</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">           </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">           </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">           //è¡¨ç¤ºå¤„äºè¯¥èŠ‚ç‚¹çš„çº¿ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">            *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> The</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> thread that enqueued </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  Initialized</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> on</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">           volatile</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Thread</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">               Node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> waitStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// Used by Condition</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">       </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        * Head of the wait queue, lazily initialized.  Except for</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        * initialization, it is modified only via method setHead.  Note:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        * If head exists, its waitStatus is guaranteed not to be</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        * CANCELLED.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">       private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> transient</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> volatile</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> head</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> //å¤´æŒ‡é’ˆ</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">   </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        * Tail of the wait queue, lazily initialized.  Modified only via</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        * method enq to add new wait node.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">       private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> transient</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> volatile</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> tail</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // å°¾æŒ‡é’ˆ</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p>Nodeçš„intå˜é‡</p></li><li><p>Nodeçš„ç­‰å¾…çŠ¶æ€waitStatusæˆå‘˜å˜é‡----volatile int waitStatus;</p></li><li><p><em>è¯´äººè¯ï¼š</em></p></li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>    *ç­‰å€™åŒºå…¶å®ƒé¡¾å®¢(å…¶å®ƒçº¿ç¨‹)çš„ç­‰å¾…çŠ¶æ€   </span></span>
<span class="line"><span>    *é˜Ÿåˆ—ä¸­æ¯ä¸ªæ’é˜Ÿçš„ä¸ªä½“å°±æ˜¯ä¸€ä¸ªNode</span></span>
<span class="line"><span>    *åˆå§‹ä¸º0ï¼ŒçŠ¶æ€ä¸Šé¢çš„å‡ ç§</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p>Nodeæ­¤ç±»çš„è®²è§£</p><ol><li><p>å†…éƒ¨ç»“æ„</p><figure><img src="/vuepress-theme-home/assets/img/image-20210920020709733.602ddec1.png" alt="image-20210920020709733" tabindex="0" loading="lazy"><figcaption>image-20210920020709733</figcaption></figure><figure><img src="/vuepress-theme-home/assets/img/image-20210920020947644.e8478a24.png" alt="image-20210920020947644" tabindex="0" loading="lazy"><figcaption>image-20210920020947644</figcaption></figure><figure><img src="/vuepress-theme-home/assets/img/image-20210920021121080.b8d0ec75.png" alt="image-20210920021121080" tabindex="0" loading="lazy"><figcaption>image-20210920021121080</figcaption></figure></li><li><p>å±æ€§è¯´æ˜</p><ol><li><img src="/vuepress-theme-home/assets/img/image-20210920021337762.bf1cb2d5.png" alt="image-20210920021337762" tabindex="0" loading="lazy"><figcaption>image-20210920021337762</figcaption></li></ol></li></ol><figure><img src="/vuepress-theme-home/assets/img/image-20210920021430111.84a83950.png" alt="image-20210920021430111" tabindex="0" loading="lazy"><figcaption>image-20210920021430111</figcaption></figure></li><li><p>AQSåŒæ­¥é˜Ÿåˆ—çš„åŸºæœ¬ç»“æ„</p></li></ol><figure><img src="/vuepress-theme-home/assets/img/image-20210920021520748.73931fda.png" alt="image-20210920021520748" tabindex="0" loading="lazy"><figcaption>image-20210920021520748</figcaption></figure><h3 id="_5ã€ä»æˆ‘ä»¬çš„reentrantlockå¼€å§‹è§£è¯»aqs-é‡ç‚¹" tabindex="-1"><a class="header-anchor" href="#_5ã€ä»æˆ‘ä»¬çš„reentrantlockå¼€å§‹è§£è¯»aqs-é‡ç‚¹"><span>5ã€ä»æˆ‘ä»¬çš„ReentrantLockå¼€å§‹è§£è¯»AQSï¼ˆé‡ç‚¹ï¼‰</span></a></h3><h4 id="lockæ¥å£çš„å®ç°ç±»-åŸºæœ¬éƒ½æ˜¯é€šè¿‡èšåˆäº†ä¸€ä¸ªé˜Ÿåˆ—åŒæ­¥å™¨çš„å­ç±»-sync-å®Œæˆçº¿ç¨‹è®¿é—®æ§åˆ¶çš„ã€‚" tabindex="-1"><a class="header-anchor" href="#lockæ¥å£çš„å®ç°ç±»-åŸºæœ¬éƒ½æ˜¯é€šè¿‡èšåˆäº†ä¸€ä¸ªé˜Ÿåˆ—åŒæ­¥å™¨çš„å­ç±»-sync-å®Œæˆçº¿ç¨‹è®¿é—®æ§åˆ¶çš„ã€‚"><span>Lockæ¥å£çš„å®ç°ç±»ï¼ŒåŸºæœ¬éƒ½æ˜¯é€šè¿‡<strong>èšåˆ</strong>äº†ä¸€ä¸ª<strong>é˜Ÿåˆ—åŒæ­¥å™¨</strong>çš„å­ç±»(sync)å®Œæˆçº¿ç¨‹è®¿é—®æ§åˆ¶çš„ã€‚</span></a></h4><h4 id="reentrantlockçš„åŸç†" tabindex="-1"><a class="header-anchor" href="#reentrantlockçš„åŸç†"><span>ReentrantLockçš„åŸç†</span></a></h4><figure><img src="/vuepress-theme-home/assets/img/image-20210920024737907.f82763f9.png" alt="image-20210920024737907" tabindex="0" loading="lazy"><figcaption>image-20210920024737907</figcaption></figure><h4 id="ä»æœ€ç®€å•çš„lockæ–¹æ³•å¼€å§‹çœ‹çœ‹å…¬å¹³å’Œéå…¬å¹³" tabindex="-1"><a class="header-anchor" href="#ä»æœ€ç®€å•çš„lockæ–¹æ³•å¼€å§‹çœ‹çœ‹å…¬å¹³å’Œéå…¬å¹³"><span>ä»æœ€ç®€å•çš„lockæ–¹æ³•å¼€å§‹çœ‹çœ‹å…¬å¹³å’Œéå…¬å¹³</span></a></h4><p>ReentrantLocké»˜è®¤éå…¬å¹³é”</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">   ReentrantLock</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lock </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ReentrantLock</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> 	   lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> 	   lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * Creates an instance of {@code ReentrantLock}.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    * This is equivalent to using {@code ReentrantLock(false)}.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ReentrantLock</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        sync </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> NonfairSync</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * Creates an instance of {@code ReentrantLock} with the</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * given fairness policy.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     *</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">@param</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> fair</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> {@code true} if this lock should use a fair ordering policy</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ReentrantLock</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">boolean</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> fair) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            sync </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> fair </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> FairSync</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">:</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> NonfairSync</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/vuepress-theme-home/assets/img/image-20210920024921569.08368823.png" alt="image-20210920024921569" tabindex="0" loading="lazy"><figcaption>image-20210920024921569</figcaption></figure><figure><img src="/vuepress-theme-home/assets/img/image-20210921003946406.5a84a2b5.png" alt="image-20210921003946406" tabindex="0" loading="lazy"><figcaption>image-20210921003946406</figcaption></figure><figure><img src="/vuepress-theme-home/assets/img/image-20210921004025670.f95e2c4d.png" alt="image-20210921004025670" tabindex="0" loading="lazy"><figcaption>image-20210921004025670</figcaption></figure><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">	ReentrantLock</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lock </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ReentrantLock</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> 	 lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> 	 lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">      //==========================</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ReentrantLock</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Lock</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E06C75;"> java.io.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Serializable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">       		sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">   		</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">   		abstract</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Sync</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> AbstractQueuedSynchronizer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">   			abstract</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> //è¢«å­ç±»å®ç°</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">		</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NonfairSync</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {...}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">		</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> FairSync</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">		</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        	final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//&lt;---ReentrantLockåˆå§‹åŒ–ä¸ºéå…¬å¹³é”æ—¶ï¼ŒReentrantLock.lock()å°†ä¼šè°ƒç”¨è¿™</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">compareAndSetState</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                    setExclusiveOwnerThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                else</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                    acquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//è°ƒç”¨çˆ¶ç±»AbstractQueuedSynchronizerçš„acquire()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       		 }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">       		 </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       		 //acquire()å°†ä¼šé—´æ¥è°ƒç”¨è¯¥æ–¹æ³•</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> acquires</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nonfairTryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(acquires);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//è°ƒç”¨çˆ¶ç±»Syncçš„nonfairTryAcquire()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥æ˜æ˜¾çœ‹å‡ºå…¬å¹³é”ä¸éå…¬å¹³é”çš„lock()æ–¹æ³•å”¯ä¸€çš„åŒºåˆ«å°±åœ¨äºå…¬å¹³é”åœ¨è·å–åŒæ­¥çŠ¶æ€æ—¶å¤šäº†ä¸€ä¸ªé™åˆ¶æ¡ä»¶ï¼šhasQueuedPredecessors()</p><p>hasQueuedPredecessorsæ˜¯å…¬å¹³é”åŠ é”æ—¶åˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨æœ‰æ•ˆèŠ‚ç‚¹çš„æ–¹æ³•</p><h4 id="éå…¬å¹³é”èµ°èµ·-æ–¹æ³•lock" tabindex="-1"><a class="header-anchor" href="#éå…¬å¹³é”èµ°èµ·-æ–¹æ³•lock"><span><strong>éå…¬å¹³é”èµ°èµ·ï¼Œæ–¹æ³•lockï¼ˆï¼‰</strong></span></a></h4><p>å¯¹æ¯”å…¬å¹³é”å’Œéå…¬å¹³é”çš„tyAcquire()æ–¹æ³•çš„å®ç°ä»£ç ï¼Œå…¶å®å·®åˆ«å°±åœ¨äºéå…¬å¹³é”è·å–é”æ—¶æ¯”å…¬å¹³é”ä¸­å°‘äº†ä¸€ä¸ªåˆ¤æ–­!hasQueuedPredecessors()</p><p>hasQueuedPredecessors()ä¸­åˆ¤æ–­äº†æ˜¯å¦éœ€è¦æ’é˜Ÿï¼Œå¯¼è‡´å…¬å¹³é”å’Œéå…¬å¹³é”çš„å·®å¼‚å¦‚ä¸‹ï¼š</p><p>å…¬å¹³é”ï¼šå…¬å¹³é”è®²ç©¶å…ˆæ¥å…ˆåˆ°ï¼Œçº¿ç¨‹åœ¨è·å–é”æ—¶ï¼Œå¦‚æœè¿™ä¸ªé”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å·²ç»æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­;</p><p>éå…¬å¹³é”ï¼šä¸ç®¡æ˜¯å¦æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœå¯ä»¥è·å–é”ï¼Œåˆ™ç«‹åˆ»å æœ‰é”å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæ’é˜Ÿçº¿ç¨‹åœ¨unpark()ï¼Œä¹‹åè¿˜æ˜¯éœ€è¦ç«äº‰é”ï¼ˆå­˜åœ¨çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹)</p><p>å¯¹æ¯”å…¬å¹³é”å’Œéå…¬å¹³é”çš„tyAcquire()æ–¹æ³•çš„å®ç°ä»£ç ï¼Œ<code>å…¶å®å·®åˆ«å°±åœ¨äºéå…¬å¹³é”è·å–é”æ—¶æ¯”å…¬å¹³é”ä¸­å°‘äº†ä¸€ä¸ªåˆ¤æ–­!hasQueuedPredecessors()</code></p><p>hasQueuedPredecessors()ä¸­åˆ¤æ–­äº†æ˜¯å¦éœ€è¦æ’é˜Ÿï¼Œå¯¼è‡´å…¬å¹³é”å’Œéå…¬å¹³é”çš„å·®å¼‚å¦‚ä¸‹ï¼š</p><p>å…¬å¹³é”ï¼šå…¬å¹³é”è®²ç©¶å…ˆæ¥å…ˆåˆ°ï¼Œçº¿ç¨‹åœ¨è·å–é”æ—¶ï¼Œå¦‚æœè¿™ä¸ªé”çš„ç­‰å¾…é˜Ÿåˆ—ä¸­å·²ç»æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­;</p><p>éå…¬å¹³é”ï¼šä¸ç®¡æ˜¯å¦æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœå¯ä»¥è·å–é”ï¼Œåˆ™ç«‹åˆ»å æœ‰é”å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæ’é˜Ÿçº¿ç¨‹åœ¨unpark()ï¼Œä¹‹åè¿˜æ˜¯éœ€è¦ç«äº‰é”ï¼ˆå­˜åœ¨çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹)</p><figure><img src="/vuepress-theme-home/assets/img/15641ff20adcaf0e8d72b5dcec7d2da1.1508958d.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><ul><li>èµ°æœ€å¸¸ç”¨çš„ï¼Œlock()/unlock(ï¼‰ä½œä¸º æ¡ˆä¾‹çªç ´å£ã€‚</li></ul><blockquote><p>å¯å‚è€ƒï¼šhttps://www.pdai.tech/md/java/thread/java-thread-x-lock-AbstractQueuedSynchronizer.html</p></blockquote><p>// TODO</p><ul><li><p>AQSæºç æ·±åº¦åˆ†æèµ°èµ·</p><ul><li><p>æ•´ä¸ªReentrantLock çš„åŠ é”è¿‡ç¨‹ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ul><li>å°è¯•åŠ é”ï¼›</li><li>åŠ é”å¤±è´¥ï¼Œçº¿ç¨‹å…¥AQSé˜Ÿåˆ—ï¼›</li><li>çº¿ç¨‹å…¥é˜Ÿåˆ—åï¼Œè¿›å…¥é˜»èµ›çŠ¶æ€ã€‚</li><li>å¯¹åº”ä¸‹é¢çš„123ä¸‰éƒ¨åˆ†ï¼ˆè„‘å›¾ï¼‰</li></ul></li></ul></li></ul><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    ReentrantLock</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lock </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ReentrantLock</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">     lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">     lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">     </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ReentrantLock</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Lock</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E06C75;"> java.io.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Serializable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        abstract</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Sync</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> AbstractQueuedSynchronizer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            abstract</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> //è¢«å­ç±»å®ç°</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NonfairSync</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">compareAndSetState</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                    setExclusiveOwnerThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                else</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                    acquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> FairSync</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//&lt;---ReentrantLockåˆå§‹åŒ–ä¸ºéå…¬å¹³é”æ—¶ï¼ŒReentrantLock.lock()å°†ä¼šè°ƒç”¨è¿™</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">compareAndSetState</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                    setExclusiveOwnerThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                else</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                    acquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//è°ƒç”¨çˆ¶ç±»AbstractQueuedSynchronizerçš„acquire()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">             </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">             //acquire()å°†ä¼šé—´æ¥è°ƒç”¨è¯¥æ–¹æ³•</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> acquires</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nonfairTryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(acquires);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//è°ƒç”¨çˆ¶ç±»Syncçš„nonfairTryAcquire()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    ä»£ç å—ä¸€</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> AQSDemo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[] </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            //éå…¬å¹³é”</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            ReentrantLock</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ReentrantLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    		//å¸¦å…¥ä¸€ä¸ªé“¶è¡ŒåŠç†ä¸šåŠ¡çš„æ¡ˆä¾‹æ¥æ¨¡æ‹Ÿæˆ‘ä»¬çš„AQS å¦‚ä½•è¿›è¡Œçº¿ç¨‹çš„ç®¡ç†å’Œé€šçŸ¥å”¤é†’æœºåˆ¶ï¼Œ</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    		//3ä¸ªçº¿ç¨‹æ¨¡æ‹Ÿ3ä¸ªæ¥é“¶è¡Œç½‘ç‚¹ï¼Œå—ç†çª—å£åŠç†ä¸šåŠ¡çš„é¡¾å®¢ã€‚</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    		</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // Aé¡¾å®¢å°±æ˜¯ç¬¬ä¸€ä¸ªé¡¾å®¢ï¼Œæ­¤æ—¶å—ç†çª—å£æ²¡æœ‰ä»»ä½•äººï¼ŒAå¯ä»¥ç›´æ¥å»åŠç†</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                try</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                    System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;-----A thread come in&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                    try</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                        TimeUnit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">MINUTES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                        e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">printStackTrace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                    lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;A&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            //ç¬¬äºŒä¸ªé¡¾å®¢ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹---ã€‹ç”±äºå—ç†ä¸šåŠ¡çš„çª—å£åªæœ‰ä¸€ä¸ª(åªèƒ½ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”)ï¼Œæ­¤æ—¶Båªèƒ½ç­‰å¾…ï¼Œ</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // è¿›å…¥å€™å®¢åŒº</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                try</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                    System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;-----B thread come in&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                    lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;B&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            //ç¬¬ä¸‰ä¸ªé¡¾å®¢ï¼Œç¬¬ä¸‰ä¸ªçº¿ç¨‹---ã€‹ç”±äºå—ç†ä¸šåŠ¡çš„çª—å£åªæœ‰ä¸€ä¸ª(åªèƒ½ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”)ï¼Œæ­¤æ—¶Cåªèƒ½ç­‰å¾…ï¼Œ</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // è¿›å…¥å€™å®¢åŒº</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                try</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                    System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;-----C thread come in&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                    lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;C&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/vuepress-theme-home/assets/img/20210125205704514.75ee6a1d.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h5 id="lockæ–¹æ³•åˆ†æ" tabindex="-1"><a class="header-anchor" href="#lockæ–¹æ³•åˆ†æ"><span>lockæ–¹æ³•åˆ†æ</span></a></h5><p>ä¸€ã€ ä»£ç å—ä¸€ï¼ŒAçº¿ç¨‹çš„ lock.lock();</p><p>äºŒã€ sync.lock(); ç‚¹å‡»sync,è¿›è¡Œæºç åˆ†æ</p><ol><li><h5 id="acquire-æ–¹æ³•åˆ†æ" tabindex="-1"><a class="header-anchor" href="#acquire-æ–¹æ³•åˆ†æ"><span>acquire()æ–¹æ³•åˆ†æ</span></a></h5></li></ol><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * Sync object for non-fair locks</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> NonfairSync</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> serialVersionUID </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 7316153563782823691L</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">         * Performs lock.  Try immediate barge, backing up to normal</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">         * acquire on failure.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">         */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">compareAndSetState</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                setExclusiveOwnerThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            else</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                acquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> acquires</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nonfairTryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(acquires);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * Acquires in exclusive mode, ignoring interrupts.  Implemented</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * by invoking at least once {@link #tryAcquire},</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * returning on success.  Otherwise the thread is queued, possibly</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * repeatedly blocking and unblocking, invoking {@link</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * #tryAcquire} until success.  This method can be used</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * to implement method {@link Lock#lock}.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     *</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">@param</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> arg</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> the acquire argument.  This value is conveyed to</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     *        {@link #tryAcquire} but is otherwise uninterpreted and</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     *        can represent anything you like.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> acquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> arg) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(arg) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            acquireQueued</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">addWaiter</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">EXCLUSIVE</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> arg))</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            selfInterrupt</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="tryacquire-age" tabindex="-1"><a class="header-anchor" href="#tryacquire-age"><span>tryAcquire(age)</span></a></h5><p>ä¸‹é¢å¯¹è¿™ä¸ªç±»ä¸­çš„ä¸¤ä¸ªåˆ¤æ–­è¿›è¡Œåˆ†åˆ«è§£è¯»ï¼š <img src="/vuepress-theme-home/assets/img/img.73647475.png" alt="img.png" loading="lazy"></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">       </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       //AåŠç†ä¸šåŠ¡æ—¶Bè¿›å…¥ï¼ŒAåŠå®Œèµ°äººï¼ŒBæŠ¢åˆ°èµ„æº</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">       if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (c </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//Bè¿æ°”å¥½ï¼ŒAèµ° stateå˜æˆ0</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">           //Bè¿æ°”å¥½ï¼ŒBå‰è„šè¿›æ¥ï¼ŒAå°±èµ°äº†</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">           if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">compareAndSetState</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> acquires)) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">               setExclusiveOwnerThread</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(current)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> //è®¾ç½®å½“å‰å ç”¨çº¿ç¨‹ä¸ºB </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">               return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  //å–åï¼Œä¸å‘ä¸‹æ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">           }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">       }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> nonfairTryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> acquires) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Thread</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> current </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            // è·å–çŠ¶æ€</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> c </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getState</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (c </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">compareAndSetState</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> acquires)) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                    setExclusiveOwnerThread</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(current)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">                }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (current </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getExclusiveOwnerThread</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> nextc </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> c </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> acquires</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (nextc </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// overflow</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                    throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Error</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Maximum lock count exceeded&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                setState</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(nextc)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æƒ…å†µ1ï¼šé¡¾å®¢Bæ­¤æ—¶èµ°å…¥å¤§å…ï¼Œå‘ç°æŸœå°æœ‰äººåœ¨åŠç†ä¸šåŠ¡ï¼Œéœ€è¦å»å€™å®¢åŒºæ’é˜Ÿï¼Œåˆšå‡†å¤‡åä¸‹æ—¶ï¼Œæ­¤æ—¶é¡¾å®¢AåŠç†å®Œæˆï¼Œå°±ç›´æ¥å»çª—å£åŠç†ï¼šåˆ¤æ–­å½“å‰stateçŠ¶æ€æ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ï¼Œè¿›è¡ŒCASæ“ä½œï¼Œå°†stateè®¾ç½®ä¸º1</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">       else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (current </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getExclusiveOwnerThread</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()) {  </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//Aé‡Šæ”¾èµ„æºåï¼ŒåˆæŠ¢åˆ°èµ„æº</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">           int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> nextc </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> c </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> acquires</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  // 2  å¯é‡å…¥é”çš„å®ç°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">           if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (nextc </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">// overflow</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">               throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Error</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Maximum lock count exceeded&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">           setState</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(nextc)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  //2  å¯é‡å…¥é”çš„å®ç°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">           return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">       }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       //é™„ä¸Šstate+1çš„æ–¹æ³•</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">       protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> setState</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> newState) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">           state </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> newState</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">       }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æƒ…å†µ2ï¼šé¡¾å®¢AåŠç†å®Œï¼Œå‡†å¤‡èµ·èº«èµ°æ—¶ï¼Œå‘ç°è¿˜æœ‰ä»¶äº‹å¿˜è®°äº†åŠç†ï¼Œåˆåä¸‹è¿›è¡ŒåŠç†ï¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºçº¿ç¨‹Aï¼Œå¦‚æœæ˜¯ï¼Œå°†stateçš„çŠ¶æ€å€¼+1ï¼Œï¼ˆ<strong>å¯é‡å…¥é”çš„å®ç°</strong>ï¼‰</p><p>æ€»ç»“ï¼šè¿™ä¸¤ç§æƒ…å½¢éƒ½æ˜¯å¯ä»¥è·å–åˆ°é”ï¼Œå³èµ°tryAcquire()æ–¹æ³•æ—¶è¿”å›true</p><h5 id="addwaiteræ–¹æ³•åˆ†æ" tabindex="-1"><a class="header-anchor" href="#addwaiteræ–¹æ³•åˆ†æ"><span>addWaiteræ–¹æ³•åˆ†æ</span></a></h5><p>ä½†ï¼Œæ­¤æ—¶ä¸¤ç§æƒ…å½¢éƒ½ä¸æ»¡è¶³ï¼šå³è¿”å›<code>false</code>ï¼Œå–åä¸º<code>true</code>ï¼Œç»§ç»­èµ°åé¢çš„æ–¹æ³•<code>addWaiter(Node.EXCLUSIVE)</code></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>  public final void acquire(int arg) {</span></span>
<span class="line"><span>      if (!tryAcquire(arg) &amp;&amp;</span></span>
<span class="line"><span>          acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span></span>
<span class="line"><span>          selfInterrupt();</span></span>
<span class="line"><span>  }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ï¼šaddWaiter(Node.EXCLUSIVE)</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      private</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> addWaiter</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Node</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> mode) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">          Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> node </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Node</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(),</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> mode)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  //å½“å‰çº¿ç¨‹ä¸ºBï¼ŒèŠ‚ç‚¹ä¸ºnull</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">          // Try the fast path of enq; backup to full enq on failure</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">         //tailä¸ºnull  å°¾ç»“ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">          Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> pred </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> tail</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (pred </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">              node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> pred</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">              if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">compareAndSetTail</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(pred</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node)) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                  pred</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                  return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">              }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">          }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">          enq</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(node)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">      }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°†tailèŠ‚ç‚¹èµ‹ç»™predèŠ‚ç‚¹ï¼Œæ­¤æ—¶å°±ä¸ºnullï¼Œä¸ä¼šè¿›å…¥ifï¼Œèµ°å…¥é˜Ÿæ–¹æ³•<code>enq(node)</code></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>private Node enq(final Node node) { //æ­¤æ—¶nodeä¸ºBé¡¾å®¢</span></span>
<span class="line"><span> for (;;) {</span></span>
<span class="line"><span>     Node t = tail;</span></span>
<span class="line"><span>     if (t == null) { // Must initialize åˆå§‹åŒ–</span></span>
<span class="line"><span>         if (compareAndSetHead(new Node()))</span></span>
<span class="line"><span>             tail = head;</span></span>
<span class="line"><span>     } else {</span></span>
<span class="line"><span>         node.prev = t;</span></span>
<span class="line"><span>         if (compareAndSetTail(t, node)) {</span></span>
<span class="line"><span>             t.next = node;</span></span>
<span class="line"><span>             return t;</span></span>
<span class="line"><span>         }</span></span>
<span class="line"><span>     }</span></span>
<span class="line"><span> }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªè‡ªæ—‹æ“ä½œï¼Œ</p><p>tailä¸ºç©ºèŠ‚ç‚¹ï¼Œä¼šè¿›å…¥<code>if</code>åˆ¤æ–­ï¼Œé€šè¿‡CASæ“ä½œè®¾ç½®<code>head</code>å¤´ç»“ç‚¹çš„æŒ‡å‘Nodeç©ºèŠ‚ç‚¹ï¼ˆæ­¤æ—¶NodeèŠ‚ç‚¹å³å›¾ä¸­çš„å‚€å„¡èŠ‚ç‚¹ï¼ˆå“¨å…µèŠ‚ç‚¹ï¼‰ï¼Œä¸å‚¨å­˜æ•°æ®ï¼Œ<code>ä»…ç”¨äºå ä½</code>ï¼‰</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>private final boolean compareAndSetHead(Node update) { //æ­¤æ—¶ä¼ å…¥çš„updateä¸ºä¸€ä¸ªNodeç©ºèŠ‚ç‚¹</span></span>
<span class="line"><span>  return unsafe.compareAndSwapObject(this, headOffset, null, update);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="/vuepress-theme-home/assets/img/20210125205754249.baef3319.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ç„¶åå†å°†<code>head</code>å¤´ç»“ç‚¹çš„æ‰§è¡Œèµ‹ç»™<code>tail</code>å°¾ç»“ç‚¹çš„æŒ‡å‘</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>tail = head;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="/vuepress-theme-home/assets/img/20210125205807664.1fd2a510.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å®Œæˆåï¼Œä¸ä¼šèµ°ä¸‹é¢çš„else åˆ†æ”¯ã€‚ç”±äºæ˜¯è‡ªæ—‹ï¼Œç»§ç»­ä»å¤´å¼€å§‹</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>private Node enq(final Node node) {</span></span>
<span class="line"><span>  for (;;) {</span></span>
<span class="line"><span>      Node t = tail;//æ­¤æ—¶tailæ‰§è¡Œç©ºèŠ‚ç‚¹ï¼Œå³ä¸ä¸ºnull</span></span>
<span class="line"><span>      if (t == null) { // Must initialize</span></span>
<span class="line"><span>          if (compareAndSetHead(new Node()))</span></span>
<span class="line"><span>              tail = head;</span></span>
<span class="line"><span>      } else {</span></span>
<span class="line"><span>          node.prev = t;//å°†Bçº¿ç¨‹çš„å‰æŒ‡é’ˆæŒ‡å‘tèŠ‚ç‚¹ï¼ˆè¿™é‡Œå³tailèŠ‚ç‚¹ï¼‰æ‰€æ‰§è¡Œçš„èŠ‚ç‚¹ï¼ˆè¿™é‡Œå³ç©ºèŠ‚ç‚¹ï¼‰</span></span>
<span class="line"><span>          if (compareAndSetTail(t, node)) {</span></span>
<span class="line"><span>              t.next = node;</span></span>
<span class="line"><span>              return t;</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ail</code>ä¸ä¸ºnullï¼Œèµ°<code>else</code>åˆ†æ”¯ï¼Œ</p><p>é¦–å…ˆï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>node.prev = t;//å°†Bçº¿ç¨‹çš„å‰æŒ‡é’ˆæŒ‡å‘ç©ºèŠ‚ç‚¹</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ç„¶åï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>t.next = node; //å°†ç©ºèŠ‚ç‚¹çš„nextæŒ‡é’ˆæŒ‡å‘é¡¾å®¢B</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æœ€åï¼š<code>return</code>ç»“æŸè‡ªæ—‹ï¼</p><hr><p>æ­¤æ—¶ï¼Œç¬¬ä¸‰ä¸ªé¡¾å®¢Cï¼Œä¹Ÿæ¥åŠç†ä¸šåŠ¡ï¼ŒåŒæ ·ä¹Ÿæ²¡æœ‰æŠ¢åˆ°é”ï¼Œéœ€è¦èµ°åˆ°<code>addWaiter(Node.EXCLUSIVE)</code>æ–¹æ³•</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>private Node addWaiter(Node mode) {</span></span>
<span class="line"><span>  Node node = new Node(Thread.currentThread(), mode);</span></span>
<span class="line"><span>  // Try the fast path of enq; backup to full enq on failure</span></span>
<span class="line"><span>  Node pred = tail; //tailèŠ‚ç‚¹æ‰§è¡Œé¡¾å®¢B</span></span>
<span class="line"><span>  if (pred != null) {</span></span>
<span class="line"><span>      node.prev = pred;</span></span>
<span class="line"><span>      if (compareAndSetTail(pred, node)) {</span></span>
<span class="line"><span>          pred.next = node;</span></span>
<span class="line"><span>          return node;</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  enq(node);</span></span>
<span class="line"><span>  return node;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤æ—¶ï¼ŒtailèŠ‚ç‚¹æ‰§è¡Œé¡¾å®¢Bï¼Œèµ‹ç»™predèŠ‚ç‚¹ï¼Œæ‰€ä»¥predèŠ‚ç‚¹ä¹Ÿæ‰§è¡ŒBï¼Œå³predä¸ä¸ºnullï¼Œéœ€è¦è¿›å…¥<code>if</code>åˆ¤æ–­</p><p>é¦–å…ˆï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>node.prev = pred;//å°†é¡¾å®¢Cçš„å¤´æŒ‡é’ˆæŒ‡å‘é¡¾å®¢B</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ç„¶åï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>compareAndSetTail(pred, node)//è®¾ç½®å°¾ç»“ç‚¹æŒ‡å‘é¡¾å®¢C</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æœ€åï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>pred.next = node;//å°†é¡¾å®¢Bçš„åæŒ‡é’ˆæŒ‡å‘é¡¾å®¢C</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="/vuepress-theme-home/assets/img/20210125205902790.567d71a4.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å‘ç°æ²¡æœ‰é¡¾å®¢Cæ²¡æœ‰èµ°<code>enq(node)</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶å·²æœ‰å“¨å…µèŠ‚ç‚¹ï¼Œä¸éœ€è¦å†å»åˆ›å»ºå“¨å…µèŠ‚ç‚¹è¿›è¡Œå ä½ã€‚</p><p>è‹¥è¿˜æœ‰å…¶ä»–é¡¾å®¢Dã€Eâ€¦èµ°è¿™æ¡è·¯ä¾ç„¶æ˜¯è¿™æ ·ã€‚</p><h5 id="acquirequeuedæ–¹æ³•åˆ†æ" tabindex="-1"><a class="header-anchor" href="#acquirequeuedæ–¹æ³•åˆ†æ"><span>acquireQueuedæ–¹æ³•åˆ†æ</span></a></h5><p>è™½ç„¶é¡¾å®¢Bå’Œé¡¾å®¢Cä¾æ¬¡éƒ½å…¥äº†é˜Ÿï¼Œä½†æ˜¯ï¼Œæ²¡æœ‰çœŸæ­£çš„é˜»å¡ï¼Œä¸‹é¢å¼€å§‹æ‰§è¡ŒacquireQueued()æ–¹æ³•</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> acquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> arg) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">         if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(arg) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">             acquireQueued</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">addWaiter</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">EXCLUSIVE</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> arg))</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">             selfInterrupt</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">     }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * Acquires in exclusive uninterruptible mode for thread already in</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * queue. Used by condition wait methods as well as acquire.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     *</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">@param</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> node</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> the node</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">@param</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> arg</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> the acquire argument</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">@return</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> {@code true} if interrupted while waiting</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> acquireQueued</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> arg) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> failed </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            //æ˜¯å¦æœ‰è¢«æ‰“æ–­</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> interrupted </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            for</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> p </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">predecessor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (p </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> head </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(arg)) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                    setHead</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(node)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                    p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // help GC</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">                    failed </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                    return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> interrupted</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">                }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">shouldParkAfterFailedAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                    parkAndCheckInterrupt</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">())</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">                    interrupted </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (failed)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                cancelAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(node)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œåˆæ˜¯ä¸€ä¸ªè‡ªæ—‹ é¦–å…ˆï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> p </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">predecessor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//è®¾ç½®pä¸ºå“¨å…µèŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">     </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     //é™„ä¸Šæºç </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> predecessor</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() throws NullPointerException {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">         Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> p </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> prev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//prevä¸ºå¤´æŒ‡é’ˆï¼Œå°†å…¶æŒ‡å‘çš„èŠ‚ç‚¹ä»˜ç»™p</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">         if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (p </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">             throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> NullPointerException</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">         else</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">             return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">     }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼šp=headç›¸ç­‰ï¼Œè¿›å…¥tryAcquireæ–¹æ³•ï¼Œå†æ¬¡å°è¯•è·å–é”ï¼Œå‡è®¾ç°åœ¨ä¾ç„¶æŠ¢ä¸åˆ°é”ï¼Œä¸èƒ½ç»§ç»­å¾€ä¸‹èµ°ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªifåˆ¤æ–­</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">shouldParkAfterFailedAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> //æŠ¢å å¤±è´¥ç­‰å¾…</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">         parkAndCheckInterrupt</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">())</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">         interrupted </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> shouldParkAfterFailedAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Node</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> pred</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node) {</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//æ­¤æ—¶predä¸ºå“¨å…µèŠ‚ç‚¹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">         int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> ws </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> pred</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">waitStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//æ­¤æ—¶ä¸º0</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">         if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (ws </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">SIGNAL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//-1</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">             /*</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  * This node has already set status asking a release</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  * to signal it, so it can safely park.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">             return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">         if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (ws </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">             /*</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  * Predecessor was cancelled. Skip over predecessors and</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  * indicate retry.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">             do</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                 node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> pred </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> pred</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">             } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">while</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pred</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">waitStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">             pred</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">         } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> { </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//è¿›å…¥æ­¤è¯­å¥</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">             /*</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  * waitStatus must be 0 or PROPAGATE.  Indicate that we</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  * need a signal, but don&#39;t park yet.  Caller will need to</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  * retry to make sure it cannot acquire before parking.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  */</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">             compareAndSetWaitStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(pred</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> ws</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">SIGNAL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  waitStatus </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">         }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">         return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">     }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿›å…¥ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">     compareAndSetWaitStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(pred</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> ws</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">SIGNAL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//è®¾ç½®waitStatusä¸º-1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ç”±äºæ˜¯è‡ªæ—‹ï¼Œå†æ¬¡è¿›å…¥acquireQueuedï¼Œå°è¯•è·å–é”ï¼Œè·å–å¤±è´¥ï¼ŒåŒç†åˆè¿›å…¥shouldParkAfterFailedAcquireæ–¹æ³•ï¼Œä½†æ­¤æ—¶waitStatuså€¼ä¸º-1ï¼Œæ‰€ä»¥è¿›å…¥ä¸‹åˆ—if</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (ws </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">SIGNAL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">         /*</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  * This node has already set status asking a release</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  * to signal it, so it can safely park.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">                  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">         return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>shouldParkAfterFailedAcquireè¿”å›ä¸ºtrueï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œ</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">shouldParkAfterFailedAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">         parkAndCheckInterrupt</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">())</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">         interrupted </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">     </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">     //æ­¤æ—¶ï¼šçœŸæ­£è¢«é˜»å¡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> parkAndCheckInterrupt</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">         LockSupport</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">park</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> //thisä¸ºèŠ‚ç‚¹B</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">         return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">interrupted</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">     }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªæ—¶å€™ï¼Œæ‰è°ƒç”¨park()æ–¹æ³•ï¼Œå°†çº¿ç¨‹è¿›è¡Œé˜»å¡ï¼ï¼ï¼æ’é˜Ÿç­‰å¾…ä¸­ã€‚ã€‚ã€‚</p><p>é¡¾å®¢CåŒç†ï¼Œéƒ½è¢«é˜»å¡åœ¨è¿™é‡Œï¼Œç›´åˆ°æ‹¿åˆ°è®¸å¯è¯ï¼Œæ‰å¯è¢«ä¾æ¬¡æ”¾è¡Œ</p><h5 id="æ–¹æ³•unlock" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•unlock"><span><strong>æ–¹æ³•unlockï¼ˆï¼‰</strong></span></a></h5><p>æ­¤æ—¶é¡¾å®¢AåŠç†å®Œä¸šåŠ¡ï¼Œå‡†å¤‡é‡Šæ”¾é”ï¼Œèµ°åˆ°<code>tryRelease</code>æ–¹æ³• AåŠç†å®Œæˆ,è°ƒç”¨lock.unlock();</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> lockAwaitSingal</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">            //    try { TimeUnit.SECONDS.sleep(3);} catch (InterruptedException e) {e.printStackTrace();}</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\t</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;------come in&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                condition</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">await</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">catch</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">InterruptedException</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">printStackTrace</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            }</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\t</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;-----è¢«å”¤é†’&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;A&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                condition</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">signal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\t</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;-----é€šçŸ¥&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            }</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;B&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">release</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//***************</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> release</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> arg) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryRelease</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(arg)) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">      Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> h </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> head</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (h </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">waitStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">          unparkSuccessor</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(h)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//***************</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryRelease</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> arg) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> UnsupportedOperationException</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//***************</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryRelease</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> releases) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> c </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getState</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> releases</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//1-1 = 0 æ­¤æ—¶cå°±ä¸º0</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getExclusiveOwnerThread</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">())</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      throw</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> IllegalMonitorStateException</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> free </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (c </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">      free </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      setExclusiveOwnerThread</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> //è®¾ç½®å½“å‰æ‹¥æœ‰é”çš„çº¿ç¨‹ä¸ºnull</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  setState</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(c)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> //åŒæ—¶è®¾ç½®stateå€¼ä¸º0</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> free</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿”å›<code>true</code>ï¼Œè¿›å…¥<code>release</code>æ–¹æ³•çš„ifè¯­å¥</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> release</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> arg) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryRelease</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(arg)) {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">      Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> h </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> head</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//å°†å¤´èŠ‚ç‚¹èµ‹ç»™h</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (h </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">waitStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//hçš„waitStarusçŠ¶æ€å€¼ä¸º-1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">          unparkSuccessor</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(h)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿›å…¥<code>unparkSuccessor(h)</code>æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> unparkSuccessor</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Node</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">      /*</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       * If status is negative (i.e., possibly needing signal) try</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       * to clear in anticipation of signalling.  It is OK if this</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       * fails or if status is changed by waiting thread.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  int</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> ws </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">waitStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">  //æ­¤æ—¶ä¸º-1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (ws </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">      compareAndSetWaitStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> ws</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> //è¿›å…¥ï¼Œé€šè¿‡CASæ“ä½œå°†çŠ¶æ€è®¾ç½®ä¸º0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">        /*</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       * Thread to unpark is held in successor, which is normally</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       * just the next node.  But if cancelled or apparently null,</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       * traverse backwards from tail to find the actual</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       * non-cancelled successor.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">       */</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (s </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">waitStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">      s </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      for</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> t </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> tail</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> t </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> t </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> t </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">waitStatus</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">              s </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (s </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//uparkå”¤é†’çº¿ç¨‹</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">      LockSupport</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unpark</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">thread</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤æ—¶ï¼Œé¡¾å®¢Bå’Œé¡¾å®¢Cæ­£æŒ‚èµ·é˜»å¡ç€ï¼Œè¿™é‡Œunparkåï¼Œç›¸å½“äºç»™äº†ä¸€å¼ è®¸å¯è¯</p><p>é¡¾å®¢Bæ¥ä¸ªå›é©¬æªï¼ï¼ï¼</p><p>é¡¾å®¢Bå†æ¬¡æ¥åˆ°è¿™ä¸ªæ–¹æ³•</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> acquireQueued</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> arg) { </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//é¡¾å®¢B</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> failed </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      boolean</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> interrupted </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      for</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Node</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> p </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">predecessor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (p </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> head </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(arg)) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">              setHead</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(node)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">              p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">next</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;"> // help GC</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">              failed </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">              return</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> interrupted</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">          }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">shouldParkAfterFailedAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> node) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">              parkAndCheckInterrupt</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">())  </span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">//Bçº¿ç¨‹ä¸€ç›´åœ¨è¿™è½¬ï¼Œç›´åˆ°unpackåæ‰§è¡Œä¸‹é¢è¯­å¥</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">              interrupted </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-dark:#7F848E;--shiki-light-font-style:italic;--shiki-dark-font-style:italic;">   //</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (failed)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">          cancelAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(node)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°è¯•è·å–é”<code>tryAcquire</code>,æ¥åˆ°<code>nonfairTryAcquire</code>æ–¹æ³•</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>final boolean nonfairTryAcquire(int acquires) {</span></span>
<span class="line"><span>  final Thread current = Thread.currentThread();</span></span>
<span class="line"><span>  int c = getState();</span></span>
<span class="line"><span>  if (c == 0) {</span></span>
<span class="line"><span>      if (compareAndSetState(0, acquires)) {</span></span>
<span class="line"><span>          setExclusiveOwnerThread(current);</span></span>
<span class="line"><span>          return true;</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  else if (current == getExclusiveOwnerThread()) {</span></span>
<span class="line"><span>      int nextc = c + acquires;</span></span>
<span class="line"><span>      if (nextc &lt; 0) // overflow</span></span>
<span class="line"><span>          throw new Error(&quot;Maximum lock count exceeded&quot;);</span></span>
<span class="line"><span>      setState(nextc);</span></span>
<span class="line"><span>      return true;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  return false;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤æ—¶stateçš„çŠ¶æ€å€¼ä¸º0ï¼Œé¡¾å®¢Bè¿›å…¥<code>if</code>åˆ¤æ–­</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>if (c == 0) {</span></span>
<span class="line"><span>  if (compareAndSetState(0, acquires)) {</span></span>
<span class="line"><span>      setExclusiveOwnerThread(current);</span></span>
<span class="line"><span>      return true;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é¦–å…ˆï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>setHead(node);//è®¾ç½®å¤´èŠ‚ç‚¹</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//é™„ä¸Šæºç </span></span>
<span class="line"><span>private void setHead(Node node) {</span></span>
<span class="line"><span>  head = node; //å°†å¤´èŠ‚ç‚¹æŒ‡å‘é¡¾å®¢B</span></span>
<span class="line"><span>  node.thread = null; //å°†é¡¾å®¢Bçš„çº¿ç¨‹è®¾ç½®ä¸ºnull</span></span>
<span class="line"><span>  node.prev = null;//å‰æŒ‡é’ˆè®¾ç½®ä¸ºnull</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åï¼šå°†å“¨å…µèŠ‚ç‚¹çš„åæŒ‡é’ˆè®¾ç½®ä¸ºnullï¼Œæ­¤æ—¶å“¨å…µèŠ‚ç‚¹ç­‰å¾…åƒåœ¾å›æ”¶</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>p.next = null; // help GC</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æ­¤æ—¶åŸé¡¾å®¢BèŠ‚ç‚¹å°±æˆä¸ºæ–°çš„å“¨å…µèŠ‚ç‚¹</p><p>åŒç†ï¼Œé¡¾å®¢Cå‡ºé˜Ÿä¹Ÿæ˜¯å¦‚æ­¤æ“ä½œï¼ï¼ï¼</p><figure><img src="/vuepress-theme-home/assets/img/20210125205953889.7c606582.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>è„‘å›¾åœ°å€ï¼šhttps://gitee.com/cuckoocry/brain-mapping.git</p><h2 id="aqsè€ƒç‚¹" tabindex="-1"><a class="header-anchor" href="#aqsè€ƒç‚¹"><span>AQSè€ƒç‚¹</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span># ç¬¬ä¸€ä¸ªè€ƒç‚¹æˆ‘ç›¸ä¿¡ä½ åº”è¯¥çœ‹è¿‡æºç äº†ï¼Œé‚£ä¹ˆAQSé‡Œé¢æœ‰ä¸ªå˜é‡å«Stateï¼Œå®ƒçš„å€¼æœ‰å‡ ç§ï¼Ÿ</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ç­” 3ä¸ªçŠ¶æ€ï¼šæ²¡å ç”¨æ˜¯0ï¼Œå ç”¨äº†æ˜¯1ï¼Œå¤§äº1æ˜¯å¯é‡å…¥é”</span></span>
<span class="line"><span></span></span>
<span class="line"><span># ç¬¬äºŒä¸ªè€ƒç‚¹ å¦‚æœABä¸¤ä¸ªçº¿ç¨‹è¿›æ¥äº†ä»¥åï¼Œè¯·é—®è¿™ä¸ªæ€»å…±æœ‰å¤šå°‘ä¸ªNodeèŠ‚ç‚¹ï¼Ÿ</span></span>
<span class="line"><span>ç­”æ¡ˆæ˜¯3ä¸ª</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/src/study-notes/shangguigu-three/AQS/README.md" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 948742327@qq.com">jiang</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/vuepress-theme-home/study-notes/shangguigu-three/await-signal.html" aria-label="await - signalé™åˆ¶"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->await - signalé™åˆ¶</div></a><a class="route-link auto-link next" href="/vuepress-theme-home/study-notes/shangguigu-three/Spring/" aria-label="Spring"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">Spring<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">å­åœ¨å·ä¸Šæ›°ï¼šâ€œé€è€…å¦‚æ–¯å¤«ï¼Œä¸èˆæ˜¼å¤œã€‚</div><div class="vp-copyright">Copyright Â© 2024 æ¨±å® </div></footer></div><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script src="/vuepress-theme-home/assets/js/runtime~app.b73d6d97.js" defer></script><script src="/vuepress-theme-home/assets/js/7172.91fc6da6.js" defer></script><script src="/vuepress-theme-home/assets/js/app.c06173f8.js" defer></script>
  </body>
</html>
